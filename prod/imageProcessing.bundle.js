(()=>{"use strict";var t,e={558:function(t,e){var a=this&&this.__awaiter||function(t,e,a,n){return new(a||(a=Promise))((function(o,i){function r(t){try{h(n.next(t))}catch(t){i(t)}}function s(t){try{h(n.throw(t))}catch(t){i(t)}}function h(t){var e;t.done?o(t.value):(e=t.value,e instanceof a?e:new a((function(t){t(e)}))).then(r,s)}h((n=n.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.genPalette=e.quantizeAndDisplay=e.displayImageFromArray=e.getDataFromElement=e.getImageData=e.height=e.width=e.KMeansCalc=e.imageColorData=e.KMeansCalculator=e.Color=void 0;class n{constructor(t,e,a,n){t=this.clampByte(t),e=this.clampByte(e),a=this.clampByte(a),null==n&&(n=255),n=this.clampByte(n),this.rgba=[t,e,a,n]}get R(){return this.rgba[0]}get G(){return this.rgba[1]}get B(){return this.rgba[2]}get A(){return this.rgba[3]}clampByte(t){return Math.max(Math.min(t,255),0)}toHex(){const t=t=>{const e=t.toString(16);return 1===e.length?"0"+e:e};return`${t(this.R)}${t(this.G)}${t(this.B)}`}distanceSqr(t){let e=this.R-t.R,a=this.G-t.G,n=this.B-t.B;return e*e+a*a+n*n}equals(t){return this.R==t.R&&this.G==t.G&&this.B==t.B}nearestInPaletteIndex(t){let e=n.CIE76DifferenceFunction,a=Number.MAX_VALUE,o=-1;for(let n=0;n<t.length;n++){let i=e(this,t[n]);i<a&&(a=i,o=n)}return o}nearestInPalette(t){return t[this.nearestInPaletteIndex(t)]}static fromHex(t){let e=parseInt(t.substring(1,3),16),a=parseInt(t.substring(3,5),16),o=parseInt(t.substring(5,7),16);return new n(e,a,o)}toLab(){let t=this.R/255,e=this.G/255,a=this.B/255,[n,o,i]=[t,e,a].map((t=>t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92)),r=.4124564*n+.3575761*o+.1804375*i,s=.2126729*n+.7151522*o+.072175*i,h=.0193339*n+.119192*o+.9503041*i,[l,c,g]=[r/.95047,s/1,h/1.08883],[d,u,p]=[l,c,g].map((t=>t>.008856?Math.pow(t,1/3):7.787*t+16/116));return[116*u-16,500*(d-u),200*(u-p)]}static deltaE76(t,e){const[a,n,o]=t,[i,r,s]=e,h=i-a,l=r-n,c=s-o;return Math.pow(h,2)+Math.pow(l,2)+Math.pow(c,2)}static deltaE2000(t,e){let[a,n,o]=t,[i,r,s]=e,h=(Math.sqrt(Math.pow(n,2)+Math.pow(o,2))+Math.sqrt(Math.pow(r,2)+Math.pow(s,2)))/2,l=.5*(1-Math.sqrt(Math.pow(h,7)/(Math.pow(h,7)+Math.pow(25,7)))),c=(1+l)*n,g=(1+l)*r,d=Math.sqrt(Math.pow(c,2)+Math.pow(o,2)),u=Math.sqrt(Math.pow(g,2)+Math.pow(s,2)),p=Math.atan2(o,c)+2*Math.PI*(Math.atan2(o,c)<0?1:0),f=Math.atan2(s,g)+2*Math.PI*(Math.atan2(s,g)<0?1:0),M=i-a,m=u-d,w=2*Math.sqrt(d*u)*Math.sin((f-p)/2),v=(a+i)/2,C=(d+u)/2,I=(p+f)/2-Math.PI*Math.abs(p-f>Math.PI?1:0),y=1-.17*Math.cos(I-Math.PI/6)+.24*Math.cos(2*I)+.32*Math.cos(3*I+Math.PI/30)-.2*Math.cos(4*I-63*Math.PI/180),D=30*Math.PI/180*Math.exp(Math.pow(-(I-275*Math.PI/180)/25,2)),x=2*Math.sqrt(Math.pow(C,7)/(Math.pow(C,7)+Math.pow(25,7))),b=1+.015*Math.pow(v-50,2)/Math.sqrt(20+Math.pow(v-50,2)),P=1+.045*C,E=1+.015*C*y,q=-Math.sin(2*D)*x;return Math.sqrt(Math.pow(M/b,2)+Math.pow(m/P,2)+Math.pow(w/E,2)+q*(m/P)*(w/E))}}e.Color=n,n.simpleDifferenceFunction=(t,e)=>t.distanceSqr(e),n.CIE76DifferenceFunction=(t,e)=>n.deltaE76(t.toLab(),e.toLab()),n.CIEDE2000DifferenceFunction=(t,e)=>n.deltaE2000(t.toLab(),e.toLab());class o{constructor(t,e){this.centroids=[],this.clusters=[];let a=[];t.forEach((t=>{t.A>=e&&a.push(t)})),this.datapoints=a}calculateKMeans(t,e,n){return a(this,void 0,void 0,(function*(){this.initializeCentroids(t);let a=!1;for(let t=0;t<e;t++){t%10==0&&console.log("iteration: "+t),n.textContent="Processing... Iteration: "+(t+1),yield new Promise((t=>setTimeout(t,0))),this.assignPointsToClusters();let e=[];for(let t=0;t<this.clusters.length;t++){let a=this.calculateCentroid(this.clusters[t]);e[t]=a}a=!0;for(let t=0;t<this.centroids.length;t++)if(!this.centroids[t].equals(e[t])){a=!1;break}if(a){console.log("Converged!"),n.textContent="Converged!",yield new Promise((t=>setTimeout(t,0)));break}this.centroids=e}return a||(n.textContent="Did not converge after "+e+" iterations.",yield new Promise((t=>setTimeout(t,0)))),this.centroids}))}initializeCentroids(t){for(console.log("Initializing centroids... "+this.datapoints.length),this.centroids=[];this.centroids.length<t;){let t=Math.floor(Math.random()*this.datapoints.length),e=this.datapoints[t],a=!1;for(let t of this.centroids)if(e.equals(t)){a=!0;break}a||(this.centroids.push(e),console.log("centroid: "+e),console.log("chose centroid: ["+e.R+", "+e.G+", "+e.B+"]"))}}assignPointsToClusters(){this.clusters=[];for(let t=0;t<this.centroids.length;t++)this.clusters.push([]);for(let t of this.datapoints){let e=Number.MAX_VALUE,a=-1;for(let n=0;n<this.centroids.length;n++){let o=t.distanceSqr(this.centroids[n]);o<e&&(e=o,a=n)}this.clusters[a].push(t)}}calculateCentroid(t){let e=0,a=0,o=0;for(let n of t)e+=n.R,a+=n.G,o+=n.B;let i=Math.floor(e/t.length),r=Math.floor(a/t.length),s=Math.floor(o/t.length);return new n(i,r,s)}}function i(t){return a(this,void 0,void 0,(function*(){console.log("attempting getting data from element asynch");const a=yield createImageBitmap(t),n=document.createElement("canvas"),o=n.getContext("2d");return e.width=t.naturalWidth,e.height=t.naturalHeight,n.width=e.width,n.height=e.height,console.log("size: "+e.width+", "+e.height),o.drawImage(a,0,0),o.getImageData(0,0,n.width,n.height)}))}function r(t,e,a,n){console.log("attempting image display. width: "+a+" height: "+n);let o=document.createElement("canvas"),i=o.getContext("2d");o.width=a,o.height=n;let r=i.createImageData(a,n),s=r.data;for(let e=0;e<t.length;e++){let a=t[e];s[4*e]=a.R,s[4*e+1]=a.G,s[4*e+2]=a.B,s[4*e+3]=255}i.putImageData(r,0,0),e.src=o.toDataURL()}e.KMeansCalculator=o,e.imageColorData=[],e.width=0,e.height=0,e.getImageData=i,e.getDataFromElement=function(t,r){return a(this,void 0,void 0,(function*(){console.log("processing data from element");let a=yield i(t);e.imageColorData=[];for(let t=0;t<e.height;t++)for(let o=0;o<e.width;o++){let i=4*(t*e.width+o),r=a.data[i],s=a.data[i+1],h=a.data[i+2],l=a.data[i+3],c=new n(r,s,h,l);e.imageColorData.push(c)}let s=1,h=1;r&&e.width>=1e3&&(s=Math.round(e.width/1e3)),r&&e.height>=500&&(h=Math.round(e.height/500)),console.log("halfway done processing data");let l=[];for(let t=0;t<e.height;t+=h)for(let a=0;a<e.width;a+=s){let n=t*e.width+a;e.imageColorData[n].A<127||l.push(e.imageColorData[n])}console.log("done processing data. points "+l.length),e.KMeansCalc=new o(l,127)}))},e.displayImageFromArray=r,e.quantizeAndDisplay=function(t,o,i,s,h){return a(this,void 0,void 0,(function*(){let a=[];i.forEach((t=>{a.push(n.fromHex(t))})),console.log("attempting quantizing");let l=(new Date).getTime(),c="namespace userconfig {\n    export const ARCADE_SCREEN_WIDTH = "+s+"\n    export const ARCADE_SCREEN_HEIGHT = "+h+"\n}\n",g="image.setPalette(hex`000000";for(let t=0;t<a.length;t++)g+=a[t].toHex();g+="`);\n";let d=[],u="let mySprite = sprites.create(img`\n";o.textContent="Adding text: 0/"+h;let p="",f=100*e.width;new n(0,0,0,0),new n(0,0,0,255);const M=new n(255,255,255,255);let m=[];for(let t=0;t<h;t++)for(let n=0;n<s;n++){let i=Math.floor(t*(e.height/h)),r=Math.floor(n*(e.width/s)),l=i*e.width+r;if(e.imageColorData[l].A<127)d.push(M),p+="0";else{let t=e.imageColorData[l].nearestInPaletteIndex(a);d.push(a[t]),p+=(t+1).toString(16)}0==n&&0!=t&&(p+="\n"),n%f==0&&(t%50==0&&(o.textContent="Adding text: "+t+"/"+h,yield new Promise((t=>setTimeout(t,0)))),m.push(p),p="")}for(let t=0;t<m.length;t++)u+=m[t];u+="`, SpriteKind.Player);\n";let w=(new Date).getTime();return console.log("time for text gen: "+(w-l)),console.log("Done text"),r(d,t,s,h),[c,g,u]}))},e.genPalette=function(t,n,o,i){return a(this,void 0,void 0,(function*(){let a=(new Date).getTime(),i=yield e.KMeansCalc.calculateKMeans(t,n,o),r=(new Date).getTime();console.log("time for palette gen: "+(r-a));let s=[];return i.forEach((t=>{s.push("#"+t.toHex())})),s}))}}},a={};function n(t){var o=a[t];if(void 0!==o)return o.exports;var i=a[t]={id:t,exports:{}};return e[t].call(i.exports,i,i.exports,n),i.exports}n.m=e,t=[],n.O=(e,a,o,i)=>{if(!a){var r=1/0;for(c=0;c<t.length;c++){for(var[a,o,i]=t[c],s=!0,h=0;h<a.length;h++)(!1&i||r>=i)&&Object.keys(n.O).every((t=>n.O[t](a[h])))?a.splice(h--,1):(s=!1,i<r&&(r=i));if(s){t.splice(c--,1);var l=o();void 0!==l&&(e=l)}}return e}i=i||0;for(var c=t.length;c>0&&t[c-1][2]>i;c--)t[c]=t[c-1];t[c]=[a,o,i]},n.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return n.d(e,{a:e}),e},n.d=(t,e)=>{for(var a in e)n.o(e,a)&&!n.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:e[a]})},n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{var t={275:0};n.O.j=e=>0===t[e];var e=(e,a)=>{var o,i,[r,s,h]=a,l=0;if(r.some((e=>0!==t[e]))){for(o in s)n.o(s,o)&&(n.m[o]=s[o]);if(h)var c=h(n)}for(e&&e(a);l<r.length;l++)i=r[l],n.o(t,i)&&t[i]&&t[i][0](),t[i]=0;return n.O(c)},a=self.webpackChunk=self.webpackChunk||[];a.forEach(e.bind(null,0)),a.push=e.bind(null,a.push.bind(a))})(),n.nc=void 0;var o=n(558);o=n.O(o)})();